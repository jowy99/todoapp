generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum CollaboratorRole {
  VIEWER
  EDITOR
}

enum TaskActivityType {
  TASK_CREATED
  TASK_UPDATED
  STATUS_CHANGED
  COMMENT_ADDED
}

enum IntegrationProvider {
  GOOGLE_CALENDAR
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  displayName  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile         Profile?
  sessions        Session[]
  lists           List[]
  tasks           Task[]
  tags            Tag[]
  memberships     ListCollaborator[]      @relation("ListMemberships")
  sentInvitations ListCollaborator[]      @relation("ListInvitations")
  taskComments    TaskComment[]           @relation("TaskCommentAuthor")
  taskActivities  TaskActivity[]          @relation("TaskActivityActor")
  integrations    IntegrationConnection[]
  feedToken       UserFeedToken?
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  bio       String   @default("")
  avatarUrl String?
  bannerUrl String?
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model List {
  id        String   @id @default(cuid())
  ownerId   String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner         User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tasks         Task[]
  collaborators ListCollaborator[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model Task {
  id          String       @id @default(cuid())
  ownerId     String
  listId      String?
  title       String
  description String       @default("")
  isCompleted Boolean      @default(false)
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  owner          User                    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  list           List?                   @relation(fields: [listId], references: [id], onDelete: SetNull)
  tags           TaskTag[]
  comments       TaskComment[]
  activities     TaskActivity[]
  externalEvents ExternalCalendarEvent[]

  @@index([ownerId, isCompleted])
  @@index([dueDate])
  @@index([listId])
}

model Tag {
  id        String   @id @default(cuid())
  ownerId   String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tasks TaskTag[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model TaskTag {
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
}

model ListCollaborator {
  id          String           @id @default(cuid())
  listId      String
  userId      String
  role        CollaboratorRole @default(VIEWER)
  invitedById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  list      List  @relation(fields: [listId], references: [id], onDelete: Cascade)
  user      User  @relation("ListMemberships", fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User? @relation("ListInvitations", fields: [invitedById], references: [id], onDelete: SetNull)

  @@unique([listId, userId])
  @@index([listId])
  @@index([userId])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@index([authorId])
}

model TaskActivity {
  id        String           @id @default(cuid())
  taskId    String
  actorId   String?
  type      TaskActivityType
  message   String
  metadata  Json?
  createdAt DateTime         @default(now())

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  actor User? @relation("TaskActivityActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([taskId, createdAt])
  @@index([actorId])
}

model IntegrationConnection {
  id                   String              @id @default(cuid())
  userId               String
  provider             IntegrationProvider
  externalAccountEmail String?
  accessToken          String?
  refreshToken         String?
  accessTokenExpiresAt DateTime?
  calendarId           String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  user   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  events ExternalCalendarEvent[]

  @@unique([userId, provider])
  @@index([provider])
}

model ExternalCalendarEvent {
  id              String   @id @default(cuid())
  integrationId   String
  taskId          String
  externalEventId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  integration IntegrationConnection @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  task        Task                  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([integrationId, taskId])
  @@index([taskId])
}

model UserFeedToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  icsToken     String   @unique
  webhookToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
